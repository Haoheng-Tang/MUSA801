---
title: "PhillyFire"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
1. What is the use case? Why is this important?

Our tool targets the fire department and residents.

The Philadelphia Fire Department responds to hundreds or even thousands of locations everyday to quell an array of emergencies. Currently, they have no ‘situational awareness’ of fire risk for a given location when an emergency call comes in. Therefore, we are going to help them create such a tool, by providing a parcel-level (building) fire risk score prediction for each property in the City; 

In addition, we want to let residents get a real-time update of the fire risk of their houses so they will have a situational awareness on risk for each property citywide


2. What are your exploratory analysis questions?

1 Are there correlations between building fires and features like property age, property type, Code Violations, 311, neighborhood, whether there are elders or infants?

2 how can the features influence the risk of nearby properties?

3 What factors should be set as default parameters for the API routines? And what factors can be acquired dynamically by API?


3. What are the team roles?

Huidi Hu - fire data/model

Zirui Chen, Haoheng Tang - API tasks


4. Gantt chart:
![Project Plan](plan.png)

```{r}
library(tidyverse)
library(ggplot2)
library(stringr)
library(httr)
library(dplyr)

# Request OPA for a building-----------------------------------------------
base_url <- "http://api.phila.gov/ais_doc/v1/"
endpoint <- "search/"
#address  <- "4701%20PINE%20ST"
#address  <- "4412E%20WINGOHOCKING%20ST"
#address <- "1955%20GRANITE%20ST"
address <- "1234%20market%20st"
#address <- "1336%20FRIENDSHIP%20ST"

#address  <-"2201N%20BROAD%20ST"
key      <- "?gatekeeperKey=6ba4de64d6ca99aa4db3b9194e37adbf"
url <- paste(base_url, endpoint, address, key, sep="")

# response <- httr::GET("http://api.phila.gov/ais_doc/v1/search/1234%20market%20st?gatekeeperKey=6ba4de64d6ca99aa4db3b9194e37adbf")
response <- httr::GET(url)
tidy_res <- httr::content(response, simplifyVector=TRUE)
length(tidy_res)

glimpse(tidy_res$features)
glimpse(tidy_res$features$properties)
glimpse(tidy_res$features$geometry)
glimpse(tidy_res$features$properties$opa_account_num)
glimpse(tidy_res)
tidy_res$features$properties$opa_account_num

#Load data------------------------------------------------------------------
library(readxl)
fire <- read_excel("./data/fire.xlsx")

library(stringr)

  
  
fire1 = fire %>%
  filter(addr_type ==1)

fire1$address <- paste(ifelse(is.na(fire1$number)==FALSE,fire1$number,''),
                       "%20",
                       ifelse(is.na(fire1$st_prefix)==FALSE,fire1$st_prefix,''),
                       "%20",
                       ifelse(is.na(fire1$street)==FALSE,fire1$street,''),
                       "%20",
                       ifelse(is.na(fire1$st_type)==FALSE,fire1$st_type,''), sep = "")

fire2 = fire %>%
  filter(addr_type ==2)

fire2$address <- paste(ifelse(is.na(fire2$xst_prefix)==FALSE,fire2$xst_prefix,''),
                       ifelse(fire2$xst_prefix!='',"%20",''),
                       ifelse(is.na(fire2$xstreet)==FALSE,fire2$xstreet,''),
                       "%20",
                       ifelse(is.na(fire2$xst_type)==FALSE,fire2$xst_type,''),
                       "%20",
                       "&",
                       "%20",
                       ifelse(is.na(fire2$st_prefix)==FALSE,fire2$st_prefix,''), 
                       ifelse(fire2$st_prefix!='',"%20",''),
                       ifelse(is.na(fire2$street)==FALSE,fire2$street,''), 
                       "%20",
                       ifelse(is.na(fire2$st_type)==FALSE,fire2$st_type,''),
                       sep = "")  

fireData <- rbind(fire1, fire2)
fireData$MUSA_ID <- paste0("MUSA_",1:nrow(fireData))

api_res <- data.frame(matrix(nrow=nrow(fireData),ncol=1))
colnames(api_res) <- "OPA_Num"
api_res <- cbind(api_res,"MUSA_ID" = fireData$MUSA_ID)

#Request OPA number for each address-------------------------------------
for (i in 1:nrow(fireData)) {
  # cat(i,"\n")
  address  <- fireData$address[[i]]
  base_url <- "http://api.phila.gov/ais/v1/"
  endpoint <- "search/"
  key      <- "?gatekeeperKey=dc953bbc4ade9d00eabf5409f6d73d3e"
  url <- paste(base_url, endpoint, address, key, sep="")
  response <- httr::GET(url)
  tidy_res <- httr::content(response, simplifyVector=TRUE)
  if (length(tidy_res) != 4){
    if(length(tidy_res$features$properties$opa_account_num)==2)
      opa_num <-  tidy_res$features$properties$opa_account_num[2]
    else
      opa_num <-  tidy_res$features$properties$opa_account_num[1]
  # fireData$opa[[i]] <- tidy_res$features$properties$opa_account_num[1]
    if(is.null(opa_num)){
      opa_num <- "OPA IS NULL"
    } else if(nchar(opa_num)==0) {
      opa_num <- "OPA IS ZERO LENGTH"
    }
    cat("Address",i,"OPA#:",opa_num,"\n")
    api_res[i,"OPA_Num"] <- opa_num
  }else{
    cat("Address",i,"NO ADDRESS FOUND!","\n")
    #fireData$opa[[i]] <- "NULL"
    api_res[i,"OPA_Num"] <- "NONE FOUND"
  }
}

#Request parcel_id for each address-------------------------------------
for (i in 1:nrow(fireData)) {
  address  <- fireData$address[[i]]
  base_url <- "http://api.phila.gov/ais/v1/"
  endpoint <- "search/"
  key      <- "?gatekeeperKey=dc953bbc4ade9d00eabf5409f6d73d3e"
  url <- paste(base_url, endpoint, address, key, sep="")
  response <- httr::GET(url)
  tidy_res <- httr::content(response, simplifyVector=TRUE)
  if (length(tidy_res) != 4){
    if(length(tidy_res$features$properties$dor_parcel_id)==2)
      parcel_id <-  tidy_res$features$properties$dor_parcel_id[2]
    else
      parcel_id <-  tidy_res$features$properties$dor_parcel_id[1]
    if(is.null(parcel_id)){
      parcel_id <- "parcel_id IS NULL"
    } else if(nchar(parcel_id)==0) {
      parcel_id <- "parcel_id IS ZERO LENGTH"
    }
    cat("Address",i,"parcel_id#:",parcel_id,"\n")
    fireData[i,"parcel_id"] <- parcel_id
  }else{
    cat("Address",i,"NO ADDRESS FOUND!","\n")
    fireData[i,"parcel_id"] <- "NONE FOUND"
  }
}
```


## EDA (interior features part)
```{r}
###loading opa & property data
opa <- read_csv("Fire_OPA_Parcel.csv")
property <- read_csv("opa_properties_public.csv")
property <- rename(property, OPA_Num = parcel_number)

fire_opa <- left_join(fireData,opa,by='MUSA_ID')
property_fire <- left_join(property,fire_opa,by='OPA_Num')

##Feature engineering
fire_property_trim <-mutate(property_fire, category = case_when(
  category_code == 1  ~ "Residential",
  category_code == 2  ~ "Hotels and Apartments",
  category_code == 3  ~ "Store with Dwelling",
  category_code == 4  ~ "Commercial",
  category_code == 5  ~ "Industrial",
  category_code == 6  ~ "Vacant Land"))

fire_property_trim <-mutate(fire_property_trim, interior = case_when(
  interior_condition == 0  ~ "Not Applicable",
  interior_condition == 2  ~ "New/Rehabbed",
  interior_condition == 3  ~ "Above Average",
  interior_condition == 4  ~ "Average",
  interior_condition == 5  ~ "Below Average",
  interior_condition == 6  ~ "Vacant",
  interior_condition == 7  ~ "Sealed / Structurally Compromised"))

fire_property_trim$year_built <- as.numeric(as.character(fire_property_trim$year_built))
fire_property_trim <-mutate(fire_property_trim, year_built_cat = case_when(
  year_built >= 1600 & year_built < 1800 ~ "1600-1800",
  year_built >= 1800 & year_built < 1900 ~ "1800s",
  year_built >= 1900 & year_built < 2000  ~ "1900s",
  year_built >= 2000 & year_built < 2010  ~ "2000-2010",
  year_built >= 2010 & year_built < 2020  ~ "2010-2020",
  year_built < 1000 | year_built >2020 ~ "Unknown"))

fire_property_trim <-mutate(fire_property_trim, isfire = case_when(
  is.na(inci_no) == FALSE  ~ "Have fire",
  is.na(inci_no) == TRUE  ~ "No fire"))

###EDA plot
#category
fire_property_trim  %>% 
  ggplot(aes(x = category, fill = isfire)) + 
  geom_bar(position = position_fill()) + 
  theme_classic() + 
  labs(y = 'Percent') + 
  coord_flip() #rotate the axis

#zoning
fire_property_trim  %>% 
  ggplot(aes(x = zoning, fill = isfire)) + 
  geom_bar(position = position_fill()) + 
  theme_classic() + 
  labs(y = 'Percent') + 
  coord_flip() 

#interior
fire_property_trim  %>% 
  ggplot(aes(x = interior, fill = isfire)) + 
  geom_bar(position = position_fill()) + 
  theme_classic() + 
  labs(y = 'Percent') + 
  coord_flip() 

#year build
fire_property_trim  %>% 
  ggplot(aes(x = year_built_cat, fill = isfire)) + 
  geom_bar(position = position_fill()) + 
  theme_classic() + 
  labs(y = 'Percent') + 
  coord_flip() 
```
## spatial

```{r}
library(tidyverse)
library(sf)
library(QuantPsyc)
library(RSocrata)
library(viridis)
library(caret)
library(spatstat)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}
```



```{r}
limit <- 
  st_read("./data/City_Limits-shp/city_limits.shp") %>%
  st_transform(2272)

ggplot() + 
  geom_sf(data = limit)
```



```{r}
fishnet <- 
  st_make_grid(limit, cellsize = 1000) %>%
  st_sf()

fishnet <- 
  fishnet[limit,] %>%
  mutate(uniqueID = rownames(.)) %>%
  dplyr::select(uniqueID)

ggplot() + 
  geom_sf(data = fishnet)
```

```{r}
library(readxl)
```


```{r}
fire <- 
  read_excel("./data/fire.xlsx")%>%
  #na.omit %>%
  #mutate(latitude = as.numeric(latitude),
  #      longitude = as.numeric(longitude)) %>% 
  #filter(latitude > 0 & 
  #         longitude > 0) %>%
  # dplyr::select(Y = latitude, X = longitude) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant")%>%
  st_set_crs(4326) %>%
  st_transform(2272)

fire <- 
  st_intersection(fire, limit)

ggplot() + 
  geom_sf(data = limit) +
  geom_sf(data = fire, colour="red", size=0.1, show.legend = "point") +
  labs(title= "Fire, Philadelphia") +
  mapTheme()
```

```{r}
fire_net <- 
  fire %>% 
  dplyr::select() %>% 
  mutate(countfire = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countfire = ifelse(is.na(countfire), 0, countfire),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

ggplot() +
  geom_sf(data = fire_net, aes(fill = countfire)) +
  scale_fill_viridis() +
  labs(title = "Count of fires for the fishnet") +
  mapTheme()
```

```{r}
type <- fire$descript barplot(prop.table(table(animals)))
hist(type)
```


```{r}
complaints <- 
  st_read("./data/complaints.csv")%>%
  filter(complaintcodename == 'VACANT HOUSE') %>%
  st_as_sf(coords = c("lng", "lat"), crs = 4326, agr = "constant")%>%
  st_set_crs(4326) %>%
  st_transform(2272)

ggplot() + 
  geom_sf(data = chicagoBoundary) +
  geom_sf(data = damage, colour="red", size=0.1, show.legend = "point") +
  labs(title= "complaints") +
  mapTheme()
```

```{r}
fire_building <- 
  fire %>%
  filter(descript == 'Building fire')

fire_building_net <- 
  fire_building %>% 
  dplyr::select() %>% 
  mutate(countfire = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countfire = ifelse(is.na(countfire), 0, countfire),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), size=nrow(fishnet), replace = TRUE))

ggplot() +
  geom_sf(data = fire_building_net, aes(fill = countfire)) +
  scale_fill_viridis() +
  labs(title = "Count of building fires for the fishnet") +
  mapTheme()
```

